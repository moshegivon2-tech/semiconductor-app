import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from bidi.algorithm import get_display
import arabic_reshaper

# --- הגדרות דף ---
st.set_page_config(page_title="Ariel Semiconductor Master", layout="wide")

# פונקציה לתיקון עברית בגרפים
def heb(text):
    if not text: return ""
    return get_display(arabic_reshaper.reshape(text))

# --- CSS לתיקון RTL ושילוב אנגלית/LaTeX ---
st.markdown("""
    <style>
    .stApp { direction: rtl; text-align: right; background-color: #f8f9fa; }
    .stMarkdown p, .stMarkdown span { direction: rtl; display: block; }
    .katex { direction: ltr !important; display: inline-block !important; font-size: 1.1em; }
    div[role="radiogroup"] { direction: rtl; text-align: right; }
    label { direction: rtl; text-align: right; display: block; font-size: 1rem; }
    </style>
    """, unsafe_allow_html=True)

# --- מאגר שאלות מלא (20 שאלות מהמקבץ שלך) ---
if 'questions' not in st.session_state:
    st.session_state.questions = [
        # דף 1
        {"topic": "Physics", "type": "decay", "q": "א. מאירים חצי דגם סיליקון סוג N ארוך בהזרקה חלשה. כתוצאה:", 
         "opts": ["(1) ריכוז עודף האלק' גדול מריכוז עודף החורים בכל ההתקן.", "(2) ריכוז עודף האלק' גדול מריכוז עודף החורים בחלק המואר בלבד.", "(3) ריכוז עודף האלק' גדול מריכוז עודף החורים בחלק החשוך בלבד.", "(4) ריכוז עודף האלק' גדול בחלק המואר מריכוזם בחלק החשוך.", "(5) ריכוז האלק' קבוע בחלק החשוך."], 
         "ans": 3, "explain": "התשובה הנכונה היא (4): ריכוז המטענים העודפים מקסימלי באזור המואר ודועך לתוך האזור החשוך."},

        {"topic": "PN Junction", "type": "iv", "q": "ב. הזרם בדיודת צמת PN הוא תמיד:", 
         "opts": ["(1) בכיוון מנוגד למתח הכולל.", "(2) תלוי אקספוננציאלית בממתח החיצוני.", "(3) סכום זרם סחיפה של אלק' ודיפוזיה של חורים.", "(4) סכום זרם סחיפה של חורים ודיפוזיה של אלקטרונים.", "(5) זרם סחיפה בממתח אחורי ודיפוזיה בממתח קידמי."], 
         "ans": 4, "explain": "התשובה הנכונה היא (5): בממתח אחורי הזרם נשלט על ידי סחיפה ובממתח קדמי על ידי דיפוזיה."},

        {"topic": "Equilibrium", "type": "ni", "q": "ג. במל''מ סוג N בשיווי משקל, איזה מהמשפטים הבאים תמיד נכון?", 
         "opts": ["(1) ריכוז החורים קבוע בכל החומר.", "(2) ריכוז האלקטרונים שווה לריכוז הסיגים.", "(3) ריכוז האלקטרונים תלוי אקספוננציאלית בטמפרטורה.", "(4) מכפלת ריכוז האלקטרונים בחורים תלויה אקספוננציאלית בטמפרטורה.", "(5) ריכוז האלקטרונים קבוע בכל החומר."], 
         "ans": 3, "explain": "מכפלת הריכוזים $n \cdot p = n_i^2$ תלויה אקספוננציאלית בטמפרטורה דרך ריבוע הריכוז האינטרינזי."},

        {"topic": "BJT", "type": "bjt", "q": "ד. בטרנזיסטור ביפולרי נדרש כי:", 
         "opts": ["(1) צומת בסיס-קולקטור יהיה בממתח אחורי.", "(2) רוחב הבסיס קטן ממרחק הדיפוזיה.", "(3) זרם הבסיס קטן מזרם הקולקטור.", "(4) רוחב הבסיס קטן מרוחב אזור המחסור של צומת בסיס-קולקטור.", "(5) רוחב הבסיס קטן מרוחב אזור המחסור של צומת בסיס-אמיטר."], 
         "ans": 1, "explain": "הדרישה הקריטית לפעולת הטרנזיסטור היא $W \ll L$."},

        {"topic": "NMOS", "type": "cv", "q": "ה. בטרנזיסטור NMOS מעלים את המתח $V_{GS}$. כתוצאה זרם הטרנזיסטור:", 
         "opts": ["(1) גדל עם המתח אלא אם כן הטרנ' ברוויה.", "(2) גדל לינארית עם המתח תמיד.", "(3) קבוע כל עוד הוא קטן מ-$V_{DS}$.", "(4) גדל תמיד עם המתח אם הטרנ' אינו בקטעון.", "(5) גדל תמיד מתכונתית לריבוע המתח."], 
         "ans": 3, "explain": "הגדלת מתח השער מעבר למתח הסף מגדילה את כמות המטען בתעלה ולכן את הזרם."},

        # דף 2
        {"topic": "Physics", "type": "decay", "q": "ו. בניסוי הארה בעוצמה P ובניסוי בעוצמה 2P, המרחק הממוצע שחודר עודף המטען בחושך הינו:", 
         "opts": ["(6) כפול בניסוי השני.", "(7) שווה בשני הניסויים.", "(8) גדול פי $\sqrt{2}$ בניסוי השני.", "(9) גדול פי $\ln 2$ בניסוי השני.", "(10) גדול פי $2e$ בניסוי השני."], 
         "ans": 1, "explain": "מרחק הדיפוזיה $L = \sqrt{D\tau}$ הוא תכונת חומר ואינו תלוי בעוצמת ההארה."},

        {"topic": "PN Junction", "type": "field", "q": "ז. סמן את המשפט הנכון עבור צומת PN בשיווי-משקל בטמפרטורת החדר:", 
         "opts": ["(6) חורים זורמים מצד N לצד P בדיפוזיה.", "(7) זרם החורים מנטרל בדיוק את זרם האלקטרונים.", "(8) אין שום זרימה של נושאי מטען.", "(9) אין זרם סחיפה כי אין שדה חשמלי.", "(10) אלקטרונים זורמים מצד N לצד P בדיפוזיה."], 
         "ans": 4, "explain": "אלקטרונים זורמים בדיפוזיה מריכוזם הגבוה (בצד N) אל הריכוז הנמוך (בצד P)."},

        {"topic": "Equilibrium", "type": "ni", "q": "ח. במל''מ סוג P בשיווי משקל, איזה מהמשפטים הבאים תמיד נכון?", 
         "opts": ["(6) ריכוז החורים קבוע בכל החומר.", "(7) ריכוז החורים גדול או שווה לריכוז הסיגים.", "(8) קצב הגנרציה של החורים שווה לקצב הרי קומבינציה שלהם.", "(9) ריכוז החורים תלוי אקספוננציאלית בטמפרטורה.", "(10) אין דיפוזיה של חורים."], 
         "ans": 2, "explain": "בשיווי משקל תרמי קצב הגנרציה שווה תמיד לקצב הריקומבינציה."},

        {"topic": "PN Junction", "type": "field", "q": "ט. בדיודת צומת בממתח קדמי, איזה מהמשפטים הבאים שגוי תמיד:", 
         "opts": ["(6) המתח הכולל קטן מהמתח המובנה.", "(7) הזרם בממתח אחורי גדל עם המתח.", "(8) הזרם בממתח קדמי גדול בדיודה ארוכה מאשר בקצרה.", "(9) השדה החשמלי מקסימלי בנקודת הצומת המטלורגי.", "(10) המתח המובנה נופל בעקרו על הצד בעל ריכוז הסיגים הנמוך."], 
         "ans": 2, "explain": "בדיודה קצרה הגרדיאנט חד יותר ולכן הזרם הקדמי גדול יותר מאשר בדיודה ארוכה."},

        {"topic": "NMOS", "type": "cv", "q": "י. בטרנזיסטור NMOS איזה מהמשפטים תמיד שגוי:", 
         "opts": ["(6) מתח השפך אף פעם לא קטן ממתח המקור.", "(7) אם הטרנזיסטור אינו קטוע הזרם ממשיך לגדול עם $V_{GS}$.", "(8) הזרם גדל עם עליית $V_{DS}$.", "(9) מטען האינברסיה בקרבת השפך גדול מאשר בקרבת המקור.", "(10) הזרם גדל מתכונתית לריבוע מתח השער."], 
         "ans": 3, "explain": "בגלל מפל המתח לאורך התעלה, ריכוז המטענים דועך ככל שמתקרבים לשפך."},

        # המשך המאגר מה-PDF
        {"topic": "BJT", "type": "bjt", "q": "יא. בטרנזיסטור PNP בתחום הפעיל הקדמי, מה שגוי?", 
         "opts": ["(11) זרם האלקטרונים צריך להיות קטן ככל האפשר.", "(12) זרם החורים מהאמיטר מגיע ברוב אל הקולקטור.", "(13) יש להגביר את הריקומבינציה בבסיס.", "(14) אלקטרונים מהבסיס זורמים אל האמיטר.", "(15) רוחב הבסיס קטן ממרחק הדיפוזיה."], 
         "ans": 2, "explain": "ריקומבינציה בבסיס מקטינה את הגבר הזרם ולכן יש להקטינה."},

        {"topic": "Equilibrium", "type": "field", "q": "יב. סמן את המשפט הנכון עבור צומת PN בשיווי-משקל:", 
         "opts": ["(11) אין כיפוף רמת פרמי.", "(12) אין כיפוף פסי אנרגיה.", "(13) אין מפל מתח על הצומת.", "(14) אין שדה חשמלי פנימי.", "(15) אין זרמי סחיפה או דיפוזיה במחסור."], 
         "ans": 0, "explain": "בשיווי משקל רמת פרמי היא שטוחה וקבועה לאורך כל ההתקן."},

        {"topic": "Physics", "type": "ni", "q": "יג. כדי לקבל הערכה של אנרגיית הפער ($E_g$) יש למדוד את:", 
         "opts": ["(11) המוליכות כתלות במתח.", "(12) הניידות כתלות במתח.", "(13) הקיבול הדיפרנציאלי כתלות במתח.", "(14) הניידות כתלות בטמפרטורה.", "(15) המוליכות כתלות בטמפרטורה."], 
         "ans": 4, "explain": "אנרגיית הפער משפיעה על התלות של $n_i$ (ומכאן המוליכות) בטמפרטורה."},

        {"topic": "PN Junction", "type": "field", "q": "יד. בהשוואה בין דיודה קצרה לארוכה (אותם סיגומים), מה נכון?", 
         "opts": ["(11) המתח המובנה בדיודה הקצרה גדול יותר.", "(12) רוחב אזור המחסור בשיווי משקל קצר יותר בקצרה.", "(13) הזרם בממתח קדמי קטן בדיודה הארוכה מאשר בקצרה.", "(14) השדה המקסימלי גדול יותר בדיודה הארוכה.", "(15) קיבול המחסור גדול בדיודה הארוכה."], 
         "ans": 2, "explain": "בדיודה ארוכה הגרדיאנט קטן יותר ולכן הזרם הקדמי נמוך יותר."},

        {"topic": "MOS", "type": "cv", "q": "טו. בקבל MOS אידאלי החליפו את התחמוצת ב-high-k. מה נכון?", 
         "opts": ["(11) מתח הסף לא השתנה.", "(12) השדה החשמלי בתחמוצת לא השתנה.", "(13) מתח יישור הפסים לא השתנה.", "(14) קיבול התחמוצת לא השתנה.", "(15) קיבול המחסור לא השתנה."], 
         "ans": 4, "explain": "קיבול המחסור תלוי בסימום המצע ולא בחומר המבודד של השער."},

        {"topic": "Conductivity", "type": "ni", "q": "א2. כשמעלים טמפרטורה של מל''מ אקסטרינזי, מה נכון לגבי המוליכות?", 
         "opts": ["(1) גדלה בכל התחומים.", "(2) גדלה רק בתחום האינטרינזי.", "(3) קטנה בתחום הקיפאון.", "(4) קטנה בתחום האינטרינזי.", "(5) יכולה לקטון בתחום האקסטרינזי."], 
         "ans": 4, "explain": "בתחום האקסטרינזי ירידת הניידות ($\mu$) עקב פיזורי סריג עשויה להוריד את המוליכות."},

        {"topic": "Diode", "type": "iv", "q": "ב2. בדיודה לא אידיאלית בסיליקון, איזו מהקביעות נכונה?", 
         "opts": ["(1) ההתנגדות הדיפרנציאלית אינסופית בממתח אחורי.", "(2) הזרם בממתח אחורי הולך וגדל.", "(3) ההתנגדות הדיפרנציאלית הגדולה ביותר היא בממתח אפס.", "(4) הזרם קבוע בממתח אחורי מעל 1V.", "(5) הזרם קבוע בממתח אחורי מעל 10V."], 
         "ans": 1, "explain": "בדיודה אמיתית קיימים זרמי דור-ריקומבינציה הגורמים לזרם לעלות עם המתח האחורי."},

        {"topic": "Physics", "type": "ni", "q": "ג2. במל''מ עם סיגים נוטלים בריכוז כפול מתורמים, באפס המוחלט רמת פרמי ממוקמת:", 
         "opts": ["(1) קרוב לאמצע הפס האסור.", "(2) קרוב לפס ההולכה.", "(3) קרוב לפס הערכיות.", "(4) לא ניתן לדעת ללא ידיעת הריכוזים.", "(5) במחצית ההפרש בין $E_{fi}$ ל-Ec."], 
         "ans": 2, "explain": "החומר הוא מסוג P (יותר נוטלים), לכן באפס המוחלט רמת פרמי צמודה לפס הערכיות."},

        {"topic": "BJT", "type": "bjt", "q": "ד2. בטרנזיסטור ביפולרי, הגדלת ריכוז הסיגים בבסיס:", 
         "opts": ["(1) מגדילה את הגבר הזרם הקידמי.", "(2) מקטינה את הגבר הזרם הקידמי.", "(3) מגדילה את הגבר הזרם האחורי.", "(4) אינה משפיעה על הגבר הזרם הקידמי.", "(5) לא ניתן לדעת."], 
         "ans": 1, "explain": "סימום גבוה בבסיס מקטין את יעילות ההזרקה מהאמיטר ומוריד את הגבר הזרם $\beta$."},

        {"topic": "NMOS", "type": "cv", "q": "ה2. נתון קבל nMOS. אם מגדילים את ריכוז $N_A$ במצע, מתח הסף $V_T$:", 
         "opts": ["(1) לא ישתנה.", "(2) אין קשר לסימום המצע.", "(3) יקטן.", "(4) יגדל.", "(5) יהפוך לאידיאלי."], 
         "ans": 3, "explain": "הגדלת סימום המצע מעלה את המטען הדרוש ליצירת אינברסיה ולכן מעלה את $V_T$."}
    ]

# --- ממשק משתמש ---
st.title("🎓 סימולטור מל''מ אריאל - מאגר שאלות מלא")

if 'idx' not in st.session_state: st.session_state.idx = 0
curr = st.session_state.questions[st.session_state.idx % len(st.session_state.questions)]

col1, col2 = st.columns([1.6, 1])
with col1:
    st.info(f"שאלה {st.session_state.idx + 1} מתוך {len(st.session_state.questions)}")
    st.markdown(f"### נושא: {heb(curr['topic'])}")
    st.markdown(f"#### {curr['q']}")
    ans = st.radio("בחר תשובה:", curr['opts'], key=f"q_{st.session_state.idx}")
    
    c_btn1, c_btn2 = st.columns(2)
    with c_btn1:
        if st.button("בדוק תשובה ✅"):
            if curr['opts'].index(ans) == curr['ans']:
                st.success("נכון מאוד! " + curr['explain']); st.balloons()
            else: st.error("טעות. רמז: " + curr['explain'])
    with c_btn2:
        if st.button("שאלה הבאה ➡️"):
            st.session_state.idx += 1; st.rerun()

with col2:
    st.write("### המחשה פיזיקלית")
    fig, ax = plt.subplots(figsize=(5, 4))
    t_type = curr.get("type", "none")
    
    if t_type == "decay":
        x = np.linspace(0, 5, 100); ax.plot(x, np.exp(-x), color='blue', lw=2)
        ax.set_title(heb("דעיכת נושאי מטען"))
    elif t_type == "field":
        x = np.linspace(-2, 2, 100); e = np.where(x < 0, 1.5+x, 1.5-3*x); e[x > 0.5] = 0; e[x < -1.5] = 0
        ax.fill_between(x, e, color='red', alpha=0.3); ax.set_title(heb("פילוג שדה חשמלי"))
    elif t_type == "cv":
        v = np.linspace(-3, 3, 100); c = np.where(v < 0, 1, 0.4)
        ax.plot(v, c, 'g', lw=2); ax.set_title(heb("אופיין קיבול-מתח"))
    elif t_type == "ni":
        t = np.linspace(250, 600, 100); ni = 1e10 * (t/300)**3 * np.exp(-1.12/(2*8.6e-5*t))
        ax.semilogy(t, ni, 'orange'); ax.set_title(heb("ריכוז ni מול טמפרטורה"))
    elif t_type == "bjt":
        ax.add_patch(plt.Rectangle((0.1, 0.3), 0.2, 0.4, color='blue', alpha=0.3))
        ax.add_patch(plt.Rectangle((0.3, 0.3), 0.1, 0.4, color='red', alpha=0.3))
        ax.add_patch(plt.Rectangle((0.4, 0.3), 0.4, 0.4, color='green', alpha=0.3))
        ax.text(0.2, 0.5, "E"); ax.text(0.35, 0.5, "B"); ax.text(0.6, 0.5, "C"); ax.axis('off')
    
    st.pyplot(fig)

st.divider()
st.caption("מבוסס על מקבץ השאלות הרשמי של אריאל. בהצלחה!")

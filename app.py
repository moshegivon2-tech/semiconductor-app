import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from bidi.algorithm import get_display
import arabic_reshaper

# --- הגדרות דף ---
st.set_page_config(page_title="Ariel Semiconductor Master", layout="wide")

# פונקציה לתיקון עברית בגרפים
def heb(text):
    if not text: return ""
    return get_display(arabic_reshaper.reshape(text))

# --- CSS חזק לתיקון RTL ושילוב אנגלית ---
st.markdown("""
    <style>
    .stApp { direction: rtl; text-align: right; background-color: #f8f9fa; }
    .stMarkdown p, .stMarkdown span { direction: rtl; display: block; }
    .katex { direction: ltr !important; display: inline-block !important; font-size: 1.15em; }
    div[role="radiogroup"] { direction: rtl; text-align: right; }
    label { direction: rtl; text-align: right; display: block; }
    </style>
    """, unsafe_allow_html=True)

# --- מאגר שאלות מלא מהקבצים והטקסט שלך  ---
if 'questions' not in st.session_state:
    st.session_state.questions = [
        # דף 1
        {"topic": "Physics", "type": "decay", "q": "מאירים חצי דגם סיליקון סוג $N$ ארוך בהזרקה חלשה. מה נכון לגבי החלק החשוך? [cite: 1-5]", "opts": ["1. ריכוז עודף האלק' גדול מריכוז עודף החורים בכל ההתקן", "2. ריכוז עודף האלק' גדול מריכוז עודף החורים בחלק המואר בלבד", "3. ריכוז האלק' קבוע בחלק החשוך"], "ans": 2, "explain": "בממתח חלש, ריכוז האלקטרונים (נושאי רוב) נשאר קבוע בקירוב בחלק החשוך."},
        {"topic": "PN Junction", "type": "field", "q": "הזרם בדיודת צומת $PN$ הוא תמיד: [cite: 6-9]", "opts": ["1. בכיוון מנוגד למתח הכולל", "2. סכום זרם סחיפה של חורים ודיפוזיה של אלקטרונים", "3. תלוי אקספוננציאלית בממתח החיצוני"], "ans": 1, "explain": "הזרם הוא סכום מרכיבי הסחיפה והדיפוזיה של המטענים."},
        {"topic": "Equilibrium", "type": "ni", "q": "במל''מ סוג $N$ בשיווי משקל, איזה מהמשפטים הבאים תמיד נכון? [cite: 10-14]", "opts": ["1. ריכוז האלקטרונים שווה לריכוז הסיגים", "2. מכפלת ריכוז האלקטרונים בחורים תלויה אקספוננציאלית בטמפרטורה", "3. ריכוז האלקטרונים קבוע בכל החומר"], "ans": 1, "explain": "מכפלת הריכוזים $n \cdot p = n_i^2$ תלויה בטמפרטורה."},
        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור ביפולרי נדרש כי: [cite: 15-19]", "opts": ["1. רוחב הבסיס קטן ממרחק הדיפוזיה", "2. צומת בסיס-קולקטור יהיה בממתח קדמי", "3. זרם הבסיס גדול מזרם הקולקטור"], "ans": 0, "explain": "תנאי הטרנזיסטור הוא $W \ll L$ כדי למנוע ריקומבינציה בבסיס."},
        {"topic": "NMOS", "type": "cv", "q": "בטרנזיסטור NMOS מעלים את המתח $V_{GS}$. כתוצאה זרם הטרנזיסטור: [cite: 20-24]", "opts": ["1. גדל תמיד עם המתח אם הטרנ' אינו בקטעון", "2. גדל לינארית עם המתח תמיד", "3. גדל תמיד מתכונתית לריבוע המתח"], "ans": 0, "explain": "הגדלת מתח השער מעלה את הזרם, אך התלות (לינארית או ריבועית) תלויה בתחום העבודה."},
        
        # דף 2
        {"topic": "Physics", "type": "decay", "q": "בניסוי עם עוצמת הארה $P$ ובניסוי עם $2P$, המרחק הממוצע שחודר עודף המטען בחלק החשוך הינו: [cite: 25-27]", "opts": ["1. כפול בניסוי השני", "2. שווה בשני הניסויים", "3. גדול פי $\sqrt{2}$ בניסוי השני"], "ans": 1, "explain": "מרחק הדיפוזיה $L = \sqrt{D \tau}$ הוא תכונת חומר ואינו תלוי בעוצמת האור."},
        {"topic": "Equilibrium", "type": "field", "q": "סמן את המשפט הנכון עבור צומת $PN$ בשיווי משקל: [cite: 29-34]", "opts": ["1. אלקטרונים זורמים מצד $N$ לצד $P$ בדיפוזיה", "2. זרם החורים מנטרל בדיוק את זרם האלקטרונים", "3. אין שום זרימה של נושאי מטען"], "ans": 0, "explain": "בשיווי משקל יש זרמי דיפוזיה וסחיפה שווים ומנוגדים לכל מוביל מטען."},
        {"topic": "Equilibrium", "type": "ni", "q": "במל''מ סוג $P$ בשיווי משקל, מה נכון תמיד? [cite: 35-40]", "opts": ["1. קצב הגנרציה של החורים שווה לקצב הריקומבינציה שלהם", "2. ריכוז החורים קבוע בכל החומר", "3. אין דיפוזיה של חורים"], "ans": 0, "explain": "בשיווי משקל תרמי, קצב הגנרציה והריקומבינציה משתווים."},
        {"topic": "PN Junction", "type": "field", "q": "בדיודת צומת בממתח קדמי, מה שגוי תמיד? [cite: 41-43]", "opts": ["1. השדה החשמלי מקסימלי בצומת המטלורגי", "2. הזרם בממתח קדמי גדול בדיודה ארוכה מאשר בקצרה", "3. המתח המובנה נופל בעקרו על הצד הפחות מסומם"], "ans": 1, "explain": "בדיודה קצרה הגרדיאנט גדול יותר, ולכן הזרם גדול יותר מאשר בדיודה ארוכה."},
        {"topic": "NMOS", "type": "cv", "q": "בטרנזיסטור NMOS איזה מהמשפטים תמיד שגוי: [cite: 44-46]", "opts": ["1. מטען האינברסיה בקרבת השפך גדול מאשר בקרבת המקור", "2. הזרם גדל עם עליית $V_{GS}$", "3. מתח השפך אף פעם לא קטן ממתח המקור"], "ans": 0, "explain": "מטען האינברסיה דועך ככל שמתקרבים לשפך (Drain) בגלל מפל המתח."},

        # דף 3
        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור PNP בתחום הפעיל הקדמי, מה שגוי? [cite: 47-49]", "opts": ["1. יש לשאוף לכך שזרם האלקטרונים יהיה קטן ככל האפשר", "2. יש להגביר את הריקומבינציה בבסיס", "3. רוחב הבסיס קטן בהרבה ממרחק הדיפוזיה"], "ans": 1, "explain": "ריקומבינציה בבסיס מקטינה את הגבר הזרם ולכן יש להקטין אותה."},
        {"topic": "Equilibrium", "type": "field", "q": "סמן משפט נכון עבור צומת $PN$ בשיווי-משקל בטמפרטורת החדר: [cite: 50-53]", "opts": ["1. אין כיפוף פסי אנרגיה", "2. אין מפל מתח על הצומת", "3. אין זרמי סחיפה או דיפוזיה במחסור"], "ans": 2, "explain": "בשיווי משקל, הזרם הנטו הוא אפס כי הסחיפה והדיפוזיה מבטלות זו את זו בכל נקודה."},
        {"topic": "Physics", "type": "ni", "q": "כדי לקבל הערכה של אנרגיית הפער ($E_g$) יש למדוד את: [cite: 54-57]", "opts": ["1. המוליכות כתלות בטמפרטורה", "2. הקיבול הדיפרנציאלי כתלות במתח", "3. הניידות כתלות במתח"], "ans": 0, "explain": "אנרגיית הפער משפיעה על התלות של $n_i$ בטמפרטורה."},
        {"topic": "PN Junction", "type": "field", "q": "בהשוואה בין דיודה קצרה לארוכה (אותם סיגומים), מה נכון? [cite: 58-61]", "opts": ["1. הזרם בממתח קדמי קטן בדיודה הארוכה מאשר בקצרה", "2. המתח המובנה בדיודה הקצרה גדול יותר", "3. קיבול המחסור גדול בדיודה הארוכה"], "ans": 0, "explain": "בדיודה ארוכה הגרדיאנט קטן יותר ולכן הזרם נמוך יותר."},
        {"topic": "MOS", "type": "cv", "q": "בקבל MOS החליפו את התחמוצת בחומר עם מקדם גבוה יותר (High-k). מה נכון? [cite: 62-65]", "opts": ["1. מתח הסף לא השתנה", "2. קיבול המחסור לא השתנה", "3. קיבול התחמוצת לא השתנה"], "ans": 1, "explain": "קיבול המחסור תלוי בסימום המצע ולא במבודד."},

        # דף 4
        {"topic": "Conductivity", "type": "ni", "q": "כשמעלים את הטמפרטורה של מל''מ אקסטרינזי, מה נכון לגבי המוליכות? [cite: 66-72]", "opts": ["1. גדלה בכל התחומים", "2. גדלה רק בתחום האינטרינזי", "3. יכולה לקטון בתחום האקסטרינזי"], "ans": 2, "explain": "בתחום האקסטרינזי, פיזורי סריג מקטינים את הניידות ($\mu$) מה שעלול להוריד את המוליכות."},
        {"topic": "Diode", "type": "iv", "q": "בדיודה לא אידיאלית בסיליקון, איזו מהקביעות נכונה? [cite: 73-78]", "opts": ["1. ההתנגדות הדיפרנציאלית אינסופית בממתח אחורי", "2. הזרם בממתח אחורי הולך וגדל", "3. ההתנגדות הדיפרנציאלית הגדולה ביותר היא בממתח אפס"], "ans": 1, "explain": "בדיודת סיליקון אמיתית יש זרמי גנרציה במחסור שגורמים לזרם האחורי לעלות מעט עם המתח."},
        {"topic": "Physics", "type": "ni", "q": "במל''מ עם סיגים נוטלים בריכוז כפול מתורמים, באפס המוחלט רמת פרמי ממוקמת: [cite: 79-85]", "opts": ["1. קרוב לפס ההולכה", "2. קרוב לפס הערכיות", "3. קרוב לאמצע הפס האסור"], "ans": 1, "explain": "החומר הוא מסוג $P$ (יותר נוטלים), לכן באפס המוחלט רמת פרמי תהיה צמודה לפס הערכיות ($E_v$)."},
        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור ביפולרי, הגדלת ריכוז הסיגים בבסיס: [cite: 86-90]", "opts": ["1. מגדילה את הגבר הזרם הקידמי", "2. מקטינה את הגבר הזרם הקידמי", "3. מגדילה את הגבר הזרם האחורי"], "ans": 1, "explain": "הגדלת סימום הבסיס מעלה את זרם הדיפוזיה מהבסיס לאמיטר ומקטינה את ה-$\\beta$."},
        {"topic": "NMOS", "type": "cv", "q": "נתון NMOS. כיצד ישתנה $V_T$ אם נגדיל את ריכוז $N_A$ במצע? [cite: 91-96]", "opts": ["1. לא ישתנה", "2. יקטן", "3. יגדל"], "ans": 2, "explain": "הגדלת סימום המצע מעלה את כמות המטען הדרושה ליצירת אינברסיה ולכן מעלה את $V_T$."}
    ]

# --- ממשק משתמש ---
st.title("🎓 סימולטור מל''מ אריאל - מאגר 100 שאלות")

if 'idx' not in st.session_state: st.session_state.idx = 0
curr = st.session_state.questions[st.session_state.idx % len(st.session_state.questions)]

col1, col2 = st.columns([1.5, 1])

with col1:
    st.info(f"שאלה {st.session_state.idx + 1} מתוך {len(st.session_state.questions)}")
    st.markdown(f"### נושא: {curr['topic']}")
    st.markdown(f"#### {curr['q']}")
    ans = st.radio("בחר תשובה:", curr['opts'], key=f"q_{st.session_state.idx}")
    
    c_btn1, c_btn2 = st.columns(2)
    with c_btn1:
        if st.button("בדוק תשובה ✅"):
            if curr['opts'].index(ans) == curr['ans']:
                st.success("נכון מאוד! " + curr['explain']); st.balloons()
            else: st.error("טעות. הסבר: " + curr['explain'])
    with c_btn2:
        if st.button("שאלה הבאה ➡️"):
            st.session_state.idx += 1; st.rerun()

with col2:
    st.write("### המחשה פיזיקלית")
    fig, ax = plt.subplots(figsize=(5, 4))
    
    if curr['type'] == "decay":
        x = np.linspace(0, 5, 100)
        ax.plot(x, np.exp(-x), color='blue', lw=2)
        ax.set_title(heb("דעיכת נושאי מטען"))
        
    elif curr['type'] == "field":
        x = np.linspace(-2, 2, 100)
        e = np.where(x < 0, 1.5+x, 1.5-3*x); e[x > 0.5] = 0; e[x < -1.5] = 0
        ax.fill_between(x, e, color='blue', alpha=0.3)
        ax.set_title(heb("שדה חשמלי בצומת"))
        
    elif curr['type'] == "cv":
        v = np.linspace(-3, 3, 100)
        c = np.where(v < 0, 1, 0.4)
        ax.plot(v, c, 'g', lw=2)
        ax.set_title(heb("עקומת קיבול-מתח (C-V)"))
        
    elif curr['type'] == "ni":
        t = np.linspace(250, 600, 100)
        ni = 1e10 * (t/300)**3 * np.exp(-1.12/(2*8.6e-5*t))
        ax.semilogy(t, ni, 'r')
        ax.set_title(heb("ריכוז ni מול טמפרטורה"))
        
    elif curr['type'] == "bjt":
        ax.text(0.5, 0.5, heb("אמיטר -> בסיס -> קולקטור"), ha='center')
        ax.set_title(heb("מבנה טרנזיסטור")); ax.axis('off')
        
    elif curr['type'] == "iv":
        v = np.linspace(-1, 0.7, 100)
        i = 1e-12 * (np.exp(v/0.026)-1)
        ax.plot(v, i, 'red')
        ax.set_title(heb("אופיין זרם-מתח"))

    st.pyplot(fig)

st.divider()
st.caption("פותח עבור הסטודנטים באריאל | מבוסס על מאגרי השאלות הרשמיים ")

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from bidi.algorithm import get_display
import arabic_reshaper

# --- הגדרות דף ---
st.set_page_config(page_title="Ariel Semiconductor Master", layout="wide")

# פונקציה לתיקון עברית בגרפים
def heb(text):
    if not text: return ""
    return get_display(arabic_reshaper.reshape(text))

# --- CSS לעברית תקנית ושילוב אנגלית/LaTeX ---
st.markdown("""
    <style>
    .stApp { direction: rtl; text-align: right; background-color: #f8f9fa; }
    .stMarkdown p, .stMarkdown span { direction: rtl; display: block; }
    .katex { direction: ltr !important; display: inline-block !important; font-size: 1.1em; }
    div[role="radiogroup"] { direction: rtl; text-align: right; }
    label { direction: rtl; text-align: right; display: block; font-size: 1.05rem; }
    </style>
    """, unsafe_allow_html=True)

# --- מאגר שאלות מלא עם 5 תשובות לכל שאלה  ---
if 'questions' not in st.session_state:
    st.session_state.questions = [
        # דף 1 [cite: 1-24]
        {"topic": "Physics", "type": "decay", "q": "מאירים חצי דגם סיליקון סוג $N$ ארוך בהזרקה חלשה. כתוצאה:", "opts": ["(1) ריכוז עודף האלק' גדול מריכוז עודף החורים בכל ההתקן.", "(2) ריכוז עודף האלק' גדול מריכוז עודף החורים בחלק המואר בלבד.", "(3) ריכוז עודף האלק' גדול מריכוז עודף החורים בחלק החשוך בלבד.", "(4) ריכוז עודף האלק' גדול בחלק המואר מריכוזם בחלק החשוך.", "(5) ריכוז האלק' קבוע בחלק החשוך."], "ans": 4, "explain": "בממתח חלש, ריכוז נושאי הרוב (אלקטרונים ב-N) נשאר קבוע בקירוב בחלק החשוך[cite: 5]."},
        
        {"topic": "PN Junction", "type": "field", "q": "הזרם בדיודת צומת $PN$ הוא תמיד:", "opts": ["(1) בכיוון מנוגד למתח הכולל.", "(2) תלוי אקספוננציאלית בממתח החיצוני.", "(3) סכום זרם סחיפה של אלק' ודיפוזיה של חורים.", "(4) סכום זרם סחיפה של חורים ודיפוזיה של אלקטרונים.", "(5) זרם סחיפה בממתח אחורי ודיפוזיה בממתח קידמי."], "ans": 3, "explain": "הזרם מורכב מסכום זרמי הסחיפה והדיפוזיה של שני סוגי המובילים[cite: 9]."},

        {"topic": "Equilibrium", "type": "ni", "q": "במל''מ סוג $N$ בשיווי משקל, איזה מהמשפטים הבאים תמיד נכון?", "opts": ["(1) ריכוז החורים קבוע בכל החומר.", "(2) ריכוז האלקטרונים שווה לריכוז הסיגים.", "(3) ריכוז האלקטרונים תלוי אקספוננציאלית בטמפרטורה.", "(4) מכפלת ריכוז האלקטרונים בחורים תלויה אקספוננציאלית בטמפרטורה.", "(5) ריכוז האלקטרונים קבוע בכל החומר."], "ans": 3, "explain": "מכפלת הריכוזים $n \cdot p = n_i^2$ תלויה אקספוננציאלית בטמפרטורה דרך ריבוע הריכוז האינטרינזי[cite: 14]."},

        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור ביפולרי נדרש כי:", "opts": ["(1) צומת בסיס-קולקטור יהיה בממתח אחורי.", "(2) רוחב הבסיס קטן ממרחק הדיפוזיה.", "(3) זרם הבסיס קטן מזרם הקולקטור.", "(4) רוחב הבסיס קטן מרוחב אזור המחסור של צומת בסיס-קולקטור.", "(5) רוחב הבסיס קטן מרוחב אזור המחסור של צומת בסיס-אמיטר."], "ans": 1, "explain": "הדרישה הקריטית היא $W \ll L$ כדי להבטיח מעבר יעיל של מובילים[cite: 17]."},

        {"topic": "NMOS", "type": "cv", "q": "בטרנזיסטור NMOS מעלים את המתח $V_{GS}$. כתוצאה זרם הטרנזיסטור:", "opts": ["(1) גדל עם המתח אלא אם כן הטרנ' ברוויה.", "(2) גדל לינארית עם המתח תמיד.", "(3) קבוע כל עוד הוא קטן מ-$V_{DS}$.", "(4) גדל תמיד עם המתח אם הטרנ' אינו בקטעון.", "(5) גדל תמיד מתכונתית לריבוע המתח."], "ans": 3, "explain": "אם הטרנזיסטור פתוח (לא בקיטעון), כל עלייה ב-$V_{GS}$ תגדיל את הזרם[cite: 23]."},

        # דף 2 [cite: 25-46]
        {"topic": "Illumination", "type": "decay", "q": "בניסוי עם עוצמת הארה $P$ ובניסוי עם $2P$, המרחק הממוצע שחודר עודף המטען בחלק החשוך הינו:", "opts": ["(6) כפול בניסוי השני.", "(7) שווה בשני הניסויים.", "(8) גדול פי $\sqrt{2}$ בניסוי השני.", "(9) גדול פי $\ln 2$ בניסוי השני.", "(10) גדול פי $2e$ בניסוי השני."], "ans": 1, "explain": "מרחק הדיפוזיה $L$ הוא תכונת חומר ואינו תלוי בעוצמת ההארה[cite: 26]."},

        {"topic": "PN Junction", "type": "field", "q": "סמן את המשפט הנכון עבור צומת $PN$ בשיווי-משקל בטמפרטורת החדר:", "opts": ["(6) חורים זורמים מצד $N$ לצד $P$ בדיפוזיה.", "(7) זרם החורים מנטרל בדיוק את זרם האלקטרונים.", "(8) אין שום זרימה של נושאי מטען (לא סחיפה ולא דיפוזיה).", "(9) אין זרם סחיפה כי אין שדה חשמלי.", "(10) אלקטרונים זורמים מצד $N$ לצד $P$ בדיפוזיה."], "ans": 4, "explain": "אלקטרונים זורמים בדיפוזיה מריכוזם הגבוה ($N$) לצד $P$[cite: 34]."},

        {"topic": "Equilibrium", "type": "ni", "q": "במל''מ סוג $P$ בשיווי משקל, איזה מהמשפטים הבאים תמיד נכון?", "opts": ["(6) ריכוז החורים קבוע בכל החומר.", "(7) ריכוז החורים גדול או שווה לריכוז הסיגים.", "(8) קצב הגנרציה של החורים שווה לקצב הריקומבינציה שלהם.", "(9) ריכוז החורים תלוי אקספוננציאלית בטמפרטורה.", "(10) אין דיפוזיה של חורים."], "ans": 2, "explain": "בשיווי משקל תרמי קצב הגנרציה והריקומבינציה שווים תמיד[cite: 38]."},

        {"topic": "PN Junction", "type": "field", "q": "בדיודת צומת בממתח קדמי, איזה מהמשפטים הבאים שגוי תמיד:", "opts": ["(6) המתח הכולל קטן (בגודלו) מהמתח המובנה.", "(7) הזרם בממתח אחורי גדל (בגודלו) עם המתח.", "(8) הזרם בממתח קדמי גדול בדיודה ארוכה מאשר בקצרה.", "(9) השדה החשמלי מקסימלי בנקודת הצומת המטלורגי.", "(10) המתח המובנה נופל בעקרו על הצד בעל ריכוז הסיגים הנמוך."], "ans": 2, "explain": "בדיודה קצרה הגרדיאנט גדול יותר, ולכן הזרם גדול יותר מדיודה ארוכה[cite: 42]."},

        {"topic": "NMOS", "type": "cv", "q": "בטרנזיסטור NMOS איזה מהמשפטים תמיד שגוי:", "opts": ["(6) מתח השפך אף פעם לא קטן ממתח המקור.", "(7) אם הטרנזיסטור אינו קטוע הזרם ממשיך לגדול עם $V_{GS}$.", "(8) הזרם גדל עם עליית $V_{DS}$.", "(9) מטען האינברסיה בקרבת השפך גדול מאשר בקרבת המקור.", "(10) הזרם גדל מתכונתית לריבוע מתח השער."], "ans": 3, "explain": "מטען האינברסיה דועך לכיוון השפך בגלל מפל המתח לאורך התעלה[cite: 46]."},

        # דף 3 [cite: 47-65]
        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור PNP בתחום הפעיל הקדמי, איזה מהמשפטים הבאים שגוי:", "opts": ["(11) יש לשאוף לכך שזרם האלקטרונים יהיה קטן ככל האפשר.", "(12) זרם החורים מהאמיטר מגיע ברובו אל הקולקטור.", "(13) יש להגביר את הריקומבינציה בבסיס.", "(14) אלקטרונים מהבסיס זורמים אל האמיטר.", "(15) רוחב הבסיס קטן בהרבה ממרחק הדיפוזיה."], "ans": 2, "explain": "הגברת הריקומבינציה מקטינה את הגבר הזרם ולכן זהו משפט שגוי[cite: 49]."},

        {"topic": "Equilibrium", "type": "field", "q": "סמן את המשפט הנכון עבור צומת $PN$ בשיווי-משקל בטמפרטורת החדר:", "opts": ["(11) אין כיפוף רמת פרמי.", "(12) אין כיפוף פסי אנרגיה.", "(13) אין מפל מתח על הצומת.", "(14) אין שדה חשמלי פנימי.", "(15) אין זרמי סחיפה או דיפוזיה במחסור."], "ans": 0, "explain": "בשיווי משקל רמת פרמי חייבת להיות שטוחה בכל ההתקן[cite: 51]."},

        {"topic": "Physics", "type": "ni", "q": "כדי לקבל הערכה של אנרגיית הפער ($E_g$) יש למדוד את:", "opts": ["(11) המוליכות כתלות במתח.", "(12) הניידות כתלות במתח.", "(13) הקיבול הדיפרנציאלי כתלות במתח.", "(14) הניידות כתלות בטמפרטורה.", "(15) המוליכות כתלות בטמפרטורה."], "ans": 4, "explain": "המוליכות בטמפרטורה גבוהה נשלטת על ידי $n_i$ שתלוי ב-$E_g$[cite: 57]."},

        {"topic": "PN Junction", "type": "field", "q": "בהשוואה בין דיודה קצרה לארוכה (אותם סיגומים), מה נכון?", "opts": ["(11) המתח המובנה בדיודה הקצרה גדול יותר.", "(12) רוחב אזור המחסור בשיווי משקל בדיודה הקצרה הוא קצר יותר.", "(13) הזרם בממתח קדמי נתון קטן בדיודה הארוכה מאשר בקצרה.", "(14) השדה המקסימלי גדול בדיודה הארוכה.", "(15) קיבול המחסור גדול בדיודה הארוכה."], "ans": 2, "explain": "הגרדיאנט בארוכה קטן יותר ולכן הזרם הקדמי נמוך יותר[cite: 60]."},

        {"topic": "MOS", "type": "cv", "q": "בקבל MOS אידאלי החליפו את התחמוצת בחומר עם מקדם גבוה יותר. מה נכון תמיד?", "opts": ["(11) מתח הסף לא השתנה.", "(12) השדה החשמלי בתחמוצת לא השתנה.", "(13) מתח יישור הפסים לא השתנה.", "(14) קיבול התחמוצת לא השתנה.", "(15) קיבול המחסור לא השתנה."], "ans": 4, "explain": "קיבול המחסור תלוי במצע ובמתח, לא בחומר הדיאלקטרי של השער[cite: 65]."},

        # דף 4 [cite: 66-96]
        {"topic": "Conductivity", "type": "ni", "q": "כשמעלים טמפרטורה של מל''מ אקסטרינזי, מה נכון לגבי המוליכות?", "opts": ["(1) גדלה בכל התחומים.", "(2) גדלה רק בתחום האינטרינזי.", "(3) קטנה בתחום הקיפאון.", "(4) קטנה בתחום האינטרינזי.", "(5) יכולה לקטון בתחום האקסטרינזי."], "ans": 4, "explain": "בתחום האקסטרינזי הניידות קטנה מה שעלול להוריד את המוליכות[cite: 72]."},

        {"topic": "Diode", "type": "iv", "q": "בדיודה לא אידאלית בסיליקון, איזו מהקביעות הבאות נכונה:", "opts": ["(1) ההתנגדות הדיפרנציאלית אינסופית בממתח אחורי.", "(2) הזרם בממתח אחורי הולך וגדל.", "(3) ההתנגדות הדיפרנציאלית הגדולה ביותר היא בממתח אפס.", "(4) הזרם קבוע בממתח אחורי מעל $1V$.", "(5) הזרם קבוע בממתח אחורי מעל $10V$."], "ans": 1, "explain": "בדיודה אמיתית קיימים זרמי דור-ריקומבינציה הגורמים לזרם לעלות עם המתח האחורי."},

        {"topic": "Physics", "type": "ni", "q": "במל''מ עם סיגים נוטלים בריכוז כפול מתורמים, באפס המוחלט רמת פרמי ממוקמת:", "opts": ["(1) קרוב לאמצע הפס האסור.", "(2) קרוב לפס ההולכה.", "(3) קרוב לפס הערכיות.", "(4) לא ניתן לדעת ללא ידיעת הריכוזים.", "(5) במחצית ההפרש בין $E_{fi}$ ל-$E_c$."], "ans": 2, "explain": "החומר הוא מסוג $P$, לכן באפס המוחלט רמת פרמי צמודה לפס הערכיות."},

        {"topic": "BJT", "type": "bjt", "q": "בטרנזיסטור ביפולרי, הגדלת ריכוז הסיגים בבסיס:", "opts": ["(1) מגדילה את הגבר הזרם הקידמי.", "(2) מקטינה את הגבר הזרם הקידמי.", "(3) מגדילה את הגבר הזרם האחורי.", "(4) אינה משפיעה על הגבר הזרם הקידמי.", "(5) לא ניתן לדעת."], "ans": 1, "explain": "סימום גבוה בבסיס מקטין את יעילות ההזרקה מהאמיטר ומוריד את הגבר הזרם[cite: 88]."},

        {"topic": "NMOS", "type": "cv", "q": "נתון קבל NMOS. אם מגדילים את ריכוז הסימום $N_A$ במצע, כיצד ישתנה $V_T$?", "opts": ["(1) לא ישתנה יחסית לשער המקורי.", "(2) אין קשר בין סימום המצע למתח $V_T$.", "(3) יקטן בהשוואה להתקן המקורי.", "(4) יגדל בהשוואה להתקן המקורי.", "(5) ההתקן יהפוך להיות אידיאלי."], "ans": 3, "explain": "הגדלת $N_A$ מעלה את המטען הדרוש ליצירת התעלה ולכן מעלה את מתח הסף[cite: 95]."}
    ]

# --- ממשק משתמש ---
st.title("🎓 סימולטור מל''מ - אוניברסיטת אריאל")

if 'idx' not in st.session_state: st.session_state.idx = 0
curr = st.session_state.questions[st.session_state.idx % len(st.session_state.questions)]

col1, col2 = st.columns([1.6, 1])

with col1:
    st.info(f"שאלה {st.session_state.idx + 1} מתוך {len(st.session_state.questions)}")
    st.subheader(f"נושא: {heb(curr['topic'])}")
    st.markdown(f"### {curr['q']}")
    ans = st.radio("בחר תשובה:", curr['opts'], key=f"q_{st.session_state.idx}")
    
    col_b1, col_b2 = st.columns(2)
    with col_b1:
        if st.button("בדוק תשובה ✅"):
            if curr['opts'].index(ans) == curr['ans']:
                st.success("נכון מאוד! " + curr['explain']); st.balloons()
            else: st.error("טעות. הסבר: " + curr['explain'])
    with col_b2:
        if st.button("שאלה הבאה ➡️"):
            st.session_state.idx += 1; st.rerun()

with col2:
    st.write("### המחשה פיזיקלית")
    fig, ax = plt.subplots(figsize=(5, 4))
    t_type = curr.get("type", "none")
    
    if t_type == "decay":
        x = np.linspace(0, 5, 100); ax.plot(x, np.exp(-x), color='blue', lw=2)
        ax.set_title(heb("דעיכת נושאי מטען")); 
    elif t_type == "field":
        x = np.linspace(-2, 2, 100); e = np.where(x < 0, 1.5+x, 1.5-3*x); e[x > 0.5] = 0; e[x < -1.5] = 0
        ax.fill_between(x, e, color='red', alpha=0.3); ax.set_title(heb("פילוג שדה חשמלי")); 
    elif t_type == "cv":
        v = np.linspace(-3, 3, 100); c = np.where(v < 0, 1, np.where(v < 1, 1 - 0.5*v, 0.4))
        ax.plot(v, c, 'g', lw=2); ax.set_title(heb("עקומת קיבול-מתח")); 
    elif t_type == "ni":
        t = np.linspace(250, 600, 100); ni = 1e10 * (t/300)**3 * np.exp(-1.12/(2*8.6e-5*t))
        ax.semilogy(t, ni, 'orange'); ax.set_title(heb("ריכוז אינטרינזי מול טמפרטורה")); 
    elif t_type == "bjt":
        ax.add_patch(plt.Rectangle((0.1, 0.3), 0.2, 0.4, color='blue', alpha=0.3))
        ax.add_patch(plt.Rectangle((0.3, 0.3), 0.1, 0.4, color='red', alpha=0.3))
        ax.add_patch(plt.Rectangle((0.4, 0.3), 0.4, 0.4, color='green', alpha=0.3))
        ax.text(0.2, 0.5, "E"); ax.text(0.35, 0.5, "B"); ax.text(0.6, 0.5, "C"); ax.axis('off'); 
    
    st.pyplot(fig)

st.divider()
st.caption("מבוסס על מקבץ השאלות הרשמי של אריאל . בהצלחה!")
